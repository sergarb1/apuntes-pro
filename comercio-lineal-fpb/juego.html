<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Retail Command Center | Elite Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800;900&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        [v-cloak] { display: none; }
        body { 
            margin: 0; 
            background: #0f172a; 
            font-family: 'Outfit', sans-serif; 
            overflow: hidden; 
            touch-action: none; 
            position: fixed; 
            width: 100%; 
            height: 100%; 
            color: white;
        }
        #game-container { 
            width: 100%; 
            height: 100%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            background: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
        }
        .modal-blur { 
            background: rgba(15, 23, 42, 0.9); 
            backdrop-filter: blur(20px); 
            display: none; 
            z-index: 200; 
            position: fixed; 
            inset: 0; 
        }
        canvas { 
            touch-action: none; 
            user-select: none; 
            -webkit-tap-highlight-color: rgba(0,0,0,0); 
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain;
        }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .legible-text {
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
        }
        
        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .scanner-line {
            height: 1px;
            background: linear-gradient(90deg, transparent, #3b82f6, transparent);
            position: absolute;
            width: 100%;
            top: 0;
            animation: scan 8s linear infinite;
            opacity: 0.1;
        }
    </style>
</head>
<body class="legible-text">

    <!-- PANTALLA DE INICIO -->
    <div id="intro-screen" class="fixed inset-0 z-[300] flex items-center justify-center p-4 bg-slate-900">
        <div class="max-w-2xl w-full glass-panel rounded-[3rem] p-10 text-center relative overflow-hidden shadow-2xl border-2 border-blue-500/20">
            <div class="w-20 h-20 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-8 shadow-xl">
                <i data-lucide="shopping-bag" class="text-white w-10 h-10"></i>
            </div>
            
            <h1 class="text-4xl font-black text-white tracking-tighter mb-4 font-display italic uppercase">
                Retail <span class="text-blue-500">Command</span> Center
            </h1>
            
            <div class="bg-white/5 rounded-2xl p-6 mb-8 text-left border border-white/5">
                <h3 class="text-blue-400 font-black text-[10px] uppercase tracking-widest mb-4 flex items-center gap-2">
                    <i data-lucide="info" class="w-3 h-3"></i> Instrucciones de Operaci√≥n
                </h3>
                <ul class="space-y-3 text-slate-300 text-sm">
                    <li class="flex items-start gap-3">
                        <i data-lucide="target" class="text-blue-500 w-4 h-4 shrink-0 mt-0.5"></i>
                        <span>Enfrentar√°s <strong>10 desaf√≠os aleatorios</strong> de gesti√≥n comercial.</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i data-lucide="brain-circuit" class="text-purple-500 w-4 h-4 shrink-0 mt-0.5"></i>
                        <span>Analiza la psicolog√≠a del cliente y la log√≠stica del lineal para decidir.</span>
                    </li>
                    <li class="flex items-start gap-3">
                        <i data-lucide="zap" class="text-orange-500 w-4 h-4 shrink-0 mt-0.5"></i>
                        <span>Cada acierto suma <strong>250‚Ç¨ de Profit</strong>. Los fallos penalizan el beneficio.</span>
                    </li>
                </ul>
            </div>

            <button onclick="startGame()" class="w-full py-5 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-black uppercase tracking-[0.3em] text-[10px] transition-all shadow-xl flex items-center justify-center gap-4 group">
                INICIAR DESAF√çO <i data-lucide="chevron-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
            </button>
        </div>
    </div>

    <!-- UI DEL JUEGO -->
    <div id="game-ui" class="hidden pointer-events-none">
        <div class="fixed top-4 left-4 right-4 flex justify-between z-10">
            <div class="flex gap-3">
                <div class="bg-slate-900/90 glass-panel p-3 px-5 rounded-xl pointer-events-auto min-w-[130px]">
                    <div class="text-[8px] font-black text-blue-400 uppercase tracking-widest mb-0.5">PROFIT</div>
                    <div id="score-ui" class="text-2xl font-black text-white tabular-nums">0‚Ç¨</div>
                </div>
                <div class="bg-slate-900/90 glass-panel p-3 px-5 rounded-xl pointer-events-auto min-w-[100px]">
                    <div class="text-[8px] font-black text-purple-400 uppercase tracking-widest mb-0.5">NIVEL</div>
                    <div id="level-ui" class="text-2xl font-black text-white tabular-nums text-center">1/10</div>
                </div>
            </div>
            
            <div class="bg-slate-900/90 glass-panel p-3 px-5 rounded-xl pointer-events-auto min-w-[130px]">
                <div class="text-[8px] font-black text-orange-400 uppercase tracking-widest mb-0.5 text-right">TIEMPO</div>
                <div id="timer-ui" class="text-2xl font-black text-white tabular-nums text-right">120s</div>
            </div>
        </div>

        <div class="fixed bottom-4 left-4 right-4 flex justify-between items-center z-10">
            <div class="flex gap-2 pointer-events-auto">
                <a href="index.html" class="bg-slate-900/90 glass-panel hover:bg-red-600/20 hover:text-red-400 text-white/50 px-4 py-2 rounded-lg text-[8px] font-black uppercase tracking-widest transition-all flex items-center gap-2">
                    <i data-lucide="power" class="w-3 h-3"></i> SALIR
                </a>
                <button onclick="restartGame()" class="bg-slate-900/90 glass-panel hover:bg-blue-600/20 hover:text-blue-400 text-white/50 px-4 py-2 rounded-lg text-[8px] font-black uppercase tracking-widest transition-all flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i> REINICIAR
                </button>
            </div>
            <div class="text-[8px] font-black text-slate-500 uppercase tracking-[0.4em]">RETAIL_PROTOCOL_v2.9</div>
        </div>
    </div>

    <!-- MODAL DE FEEDBACK / GAME OVER -->
    <div id="feedback-modal" class="modal-blur items-center justify-center p-4">
        <div class="bg-slate-900 glass-panel rounded-[2.5rem] max-w-md w-full max-h-[85vh] flex flex-col overflow-hidden shadow-2xl relative border border-white/10">
            
            <div id="modal-header" class="p-6 text-white flex justify-between items-center bg-blue-600 shrink-0">
                <div>
                    <span id="modal-status" class="text-[8px] font-black uppercase tracking-[0.4em] opacity-80 block mb-1">REPORTE COMERCIAL</span>
                    <h3 id="modal-title" class="text-xl font-black uppercase italic leading-none">¬°RESULTADO OK!</h3>
                </div>
                <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                    <i id="modal-icon" data-lucide="check-circle" class="w-6 h-6"></i>
                </div>
            </div>
            
            <div id="modal-content" class="p-8 space-y-6 overflow-y-auto custom-scroll relative z-10">
                <div id="feedback-body">
                    <div class="mb-6">
                        <p id="modal-desc" class="text-slate-100 text-lg leading-relaxed font-semibold italic text-center">...</p>
                    </div>
                    
                    <div class="bg-blue-600/10 p-5 rounded-2xl border border-blue-500/20 flex items-start gap-4">
                        <div class="w-10 h-10 bg-orange-600 text-white rounded-xl flex items-center justify-center shrink-0 shadow-lg">
                            <i data-lucide="zap" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h4 class="text-[8px] font-black text-orange-400 uppercase tracking-widest mb-1">PRO TIP</h4>
                            <p id="modal-tip" class="text-white text-[13px] font-bold leading-snug">...</p>
                        </div>
                    </div>
                </div>

                <div class="pt-2">
                    <button id="next-btn" onclick="closeModal()" class="w-full bg-white text-black py-4 rounded-xl font-black uppercase tracking-[0.2em] text-[10px] hover:bg-blue-600 hover:text-white transition-all shadow-xl flex items-center justify-center gap-3">
                        SIGUIENTE NIVEL <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                    
                    <div id="gameover-btns" class="hidden space-y-3">
                        <button onclick="restartGame()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase tracking-[0.2em] text-[10px] hover:bg-blue-500 transition-all">
                            NUEVO INTENTO
                        </button>
                        <a href="index.html" class="block w-full bg-white/5 text-white py-4 rounded-xl font-black uppercase tracking-[0.2em] text-[10px] hover:bg-white/10 text-center border border-white/5 transition-all">
                            VOLVER AL HUB
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-container"></div>

    <script>
        const allQuestions = [
            { icon: "üèóÔ∏è", text: "¬øCu√°l es el nivel del lineal apodado como el 'Nivel Diamante'?", options: ["Nivel del Suelo", "Nivel de las Manos", "Nivel de los Ojos", "Nivel de la Cabeza"], correct: 2, explanation: "El nivel de los ojos genera el impacto visual inmediato sin esfuerzo. Es donde se sit√∫an los productos con mayor margen.", tip: "Coloca siempre las novedades tecnol√≥gicas o perfumes de lujo en este nivel para maximizar el deseo de compra." },
            { icon: "üìä", text: "¬øQu√© porcentaje de ventas suele representar el Nivel de los Ojos?", options: ["Alrededor del 10%", "Alrededor del 25%", "M√°s del 50%", "El 100%"], correct: 2, explanation: "M√°s de la mitad de las compras decididas en el lineal ocurren en este nivel gracias a la percepci√≥n directa.", tip: "Si un producto no se vende, s√∫belo a los ojos. Las ventas pueden aumentar un 35% de forma instant√°nea." },
            { icon: "üëê", text: "¬øPara qu√© tipo de productos es ideal el Nivel de las Manos (80-120cm)?", options: ["Productos pesados", "Productos de consumo diario y alta rotaci√≥n", "Productos de m√°ximo lujo", "Cajas vac√≠as"], correct: 1, explanation: "Es el nivel de la 'comodidad f√≠sica'. El cliente solo tiene que estirar el brazo. Ideal para productos de h√°bito.", tip: "Pon aqu√≠ productos que el cliente busca por h√°bito para agilizar su recorrido de compra." },
            { icon: "‚öñÔ∏è", text: "Si un producto es voluminoso y de bajo precio, ¬ød√≥nde va?", options: ["Nivel de la Cabeza", "Nivel de los Ojos", "Nivel de las Manos", "Nivel del Suelo"], correct: 3, explanation: "El suelo es para productos que el cliente carga por su bajo precio o necesidad (agua, sacos de pienso).", tip: "Los productos pesados abajo evitan accidentes y dan sensaci√≥n de abundancia en la tienda." },
            { icon: "üëÄ", text: "¬øQu√© es el 'Facing' m√≠nimo recomendado para ser detectado?", options: ["1 unidad", "2 unidades", "3 unidades", "10 unidades"], correct: 2, explanation: "El cerebro humano necesita repetici√≥n visual. Menos de 3 caras de un producto suelen pasar desapercibidas.", tip: "Si tienes poco stock de un producto, j√∫ntalo todo en un solo bloque para simular un facing potente." },
            { icon: "üî•", text: "¬øQu√© es una Zona Caliente en el punto de venta?", options: ["La secci√≥n de panader√≠a", "Zonas de paso obligado como entrada y cajas", "Zonas oscuras del fondo", "El probador"], correct: 1, explanation: "Son las 'autopistas' de la tienda. El cliente fluye por ellas de forma natural. Minas de oro para impulsos.", tip: "Usa la l√≠nea de cajas para vender productos peque√±os de alto margen como chicles o pilas." },
            { icon: "‚û°Ô∏è", text: "La 'Regla de la Derecha' indica que el cliente...", options: ["Gira a la izquierda siempre", "Busca siempre el lado derecho al entrar", "Solo compra a la derecha", "Entra por la derecha"], correct: 1, explanation: "Por inercia f√≠sica, la mayor√≠a tiende a girar hacia la derecha al entrar en un espacio desconocido.", tip: "Sit√∫a tu producto con m√°s margen justo en esa primera zona de giro a la derecha." },
            { icon: "ü™ù", text: "¬øQu√© es un producto 'Gancho'?", options: ["Un producto que se cuelga", "Un producto b√°sico que atrae al fondo", "Un producto de regalo", "Un descuento falso"], correct: 1, explanation: "Productos como la leche o el pan se ponen al fondo para obligar al cliente a cruzar toda la tienda.", tip: "Al poner el pan al fondo, el cliente ver√° decenas de ofertas 'calientes' antes de llegar a lo que buscaba." },
            { icon: "üìè", text: "La implantaci√≥n VERTICAL se caracteriza por...", options: ["Poner productos en el techo", "Ocupar todos los niveles con una marca", "Poner productos tumbados", "Usar solo el estante central"], correct: 1, explanation: "Crea un bloque visual de arriba a abajo. Es la m√°s efectiva porque el cliente ve la marca a cualquier altura.", tip: "Usa la implantaci√≥n vertical para dar imagen de orden y profesionalidad." },
            { icon: "‚ö°", text: "¬øQu√© es la 'Venta por Impulso'?", options: ["Ventas que se hacen r√°pido", "Compras no planeadas decididas al ver el producto", "Devoluciones r√°pidas", "Ventas a presi√≥n"], correct: 1, explanation: "Ocurre cuando el cliente ve algo que no buscaba pero lo desea en ese momento (caprichos, snacks).", tip: "Los productos de impulso deben tener un precio bajo para que el cliente no tenga que 'pensar' la compra." },
            { icon: "üóëÔ∏è", text: "¬øPara qu√© sirve un poco de desorden en cubetas de ofertas?", options: ["Mala imagen", "Sugerir que es una 'ganga' o liquidaci√≥n", "Menos trabajo", "Para nada"], correct: 1, explanation: "Psicolog√≠a de precios: un contenedor revuelto indica que el producto es muy barato y hay que 'rebuscar'.", tip: "No ordenes perfectamente las cestas de calcetines baratos; vender√°s menos." },
            { icon: "üîó", text: "¬øQu√© es el Cross-Merchandising?", options: ["Vender productos de otro pa√≠s", "Poner juntos productos que se complementan", "Vender cruzado", "Poner productos en cruz"], correct: 1, explanation: "Poner juntos productos que se complementan: patatas fritas junto a cervezas. Facilita la vida al cliente.", tip: "Si vendes pasta, pon el tomate frito justo al lado. Ticket medio garantizado." },
            { icon: "üë∂", text: "¬øCu√°l es el nivel ideal para productos infantiles?", options: ["Nivel Cabeza", "Nivel Ojos Adultos", "Nivel Manos / Suelo (a su altura)", "En el almac√©n"], correct: 2, explanation: "Situar el producto a la altura de los ojos del ni√±o (80-100cm) para que lo pida directamente.", tip: "Si el ni√±o puede tocar el juguete, las probabilidades de que sus padres lo compren suben un 70%." },
            { icon: "üîö", text: "¬øQu√© es una 'Cabecera de G√≥ndola'?", options: ["El principio de la tienda", "Los extremos de los pasillos", "El techo", "Donde se sienta el jefe"], correct: 1, explanation: "Zonas de m√°xima visibilidad de un pasillo. Por ellas pasa todo el tr√°fico transversal.", tip: "Reserva las cabeceras para promociones temporales muy fuertes o lanzamientos." },
            { icon: "üí∞", text: "El margen de beneficio se calcula como...", options: ["Precio Venta + Coste", "Precio Venta - Coste", "Precio Venta / 2", "Solo el IVA"], correct: 1, explanation: "Es el beneficio bruto por unidad. Si vendo por 10 y me cost√≥ 6, mi margen son 4 euros.", tip: "Un producto con poco margen debe compensarse con una rotaci√≥n alt√≠sima." },
            { icon: "üîÑ", text: "¬øQu√© es la 'Alta Rotaci√≥n'?", options: ["Productos que giran", "Productos que se venden y reponen muy r√°pido", "Cambio de personal", "Productos que caducan"], correct: 1, explanation: "Productos b√°sicos que 'vuelan' de los estantes. Motores de flujo de la tienda.", tip: "La alta rotaci√≥n genera tr√°fico, pero el alto margen genera la riqueza real." },
            { icon: "üì¶", text: "¬øQu√© significa el t√©rmino 'Stock de Seguridad'?", options: ["Stock para evitar robos", "Cantidad m√≠nima para evitar roturas", "Stock bajo llave", "Stock caro"], correct: 1, explanation: "Es el inventario extra para absorber fluctuaciones en la demanda o retrasos.", tip: "Calcula bien tu stock de seguridad para no perder ventas ni tener dinero inmovilizado." },
            { icon: "üßä", text: "¬øQu√© es una 'Zona Fr√≠a' en retail?", options: ["Zona de congelados", "Espacios con poco flujo natural", "La entrada", "Oficinas"], correct: 1, explanation: "Zonas donde los clientes no circulan por inercia. Esquinas o pasillos sin salida.", tip: "Coloca un producto gancho en una zona fr√≠a para 'calentarla' y atraer tr√°fico." },
            { icon: "üè∑Ô∏è", text: "¬øQu√© es el 'Pricing' psicol√≥gico de terminar en ,99?", options: ["Es obligatorio", "Percepci√≥n de que el precio es menor", "F√°cil de cobrar", "Contar monedas"], correct: 1, explanation: "El cerebro procesa el primer d√≠gito primero. 9,99‚Ç¨ se percibe m√°s cerca de 9‚Ç¨ que de 10‚Ç¨.", tip: "Usa precios terminados en impar para ofertas y redondos para lujo." },
            { icon: "üîà", text: "¬øC√≥mo afecta el hilo musical r√°pido a las ventas?", options: ["Compran m√°s", "Aumenta la velocidad de circulaci√≥n", "Relaja", "No afecta"], correct: 1, explanation: "La m√∫sica r√°pida aumenta el ritmo card√≠aco y hace que el cliente se mueva m√°s r√°pido.", tip: "Usa m√∫sica lenta en horas valle para que el cliente pase m√°s tiempo y gaste m√°s." },
            { icon: "üî¶", text: "¬øQu√© tipo de luz resalta la frescura de la carne?", options: ["Luz azulada", "Luz con tonos rosados", "Luz blanca fr√≠a", "Luz verde"], correct: 1, explanation: "La luz rosada acent√∫a el color rojo de la carne haci√©ndola parecer m√°s fresca.", tip: "Usa luz c√°lida para panader√≠a y blanca potente para tecnolog√≠a." },
            { icon: "üõë", text: "¬øQu√© es un 'Stop-Client' o rompetr√°fico?", options: ["Guardia", "Elemento visual que sobresale del lineal", "Cartel prohibido", "Oferta falsa"], correct: 1, explanation: "Elemento perpendicular al lineal que obliga al ojo a detenerse mientras se camina.", tip: "No abuses de los stop-clients o crear√°s un ruido visual que el cliente ignorar√°." },
            { icon: "üìâ", text: "¬øQu√© es la 'Merma' en un comercio?", options: ["Descuento", "P√©rdida de valor o cantidad del stock", "Beneficio neto", "Sueldo"], correct: 1, explanation: "Diferencia entre stock te√≥rico y real por hurtos, errores o deterioro.", tip: "Una merma superior al 2% puede destruir la rentabilidad de una secci√≥n." },
            { icon: "üíé", text: "El Merchandising de Gesti√≥n busca...", options: ["Tienda bonita", "Optimizar rotaci√≥n y rentabilidad", "Contratar gente", "Publicidad"], correct: 1, explanation: "Se centra en los n√∫meros: ventas por m2, gesti√≥n de stocks y m√°rgenes.", tip: "Lo que no se mide, no se puede mejorar. Analiza semanalmente tu rentabilidad." },
            { icon: "üß•", text: "¬øQu√© es el 'Visual Merchandising'?", options: ["Contar dinero", "Presentaci√≥n est√©tica de productos", "Vender ropa", "Limpiar"], correct: 1, explanation: "Arte de presentar el producto de forma que se venda solo a trav√©s de la vista.", tip: "Un maniqu√≠ con el look completo vende un 40% m√°s que las prendas dobladas." },
            { icon: "üè∑Ô∏è", text: "¬øQu√© es el etiquetado 'EAN'?", options: ["Un nombre", "C√≥digo de barras est√°ndar", "Tipo de tela", "Precio"], correct: 1, explanation: "Permite la gesti√≥n automatizada del stock y el paso r√°pido por caja.", tip: "Un c√≥digo de barras mal impreso ralentiza la caja y genera frustraci√≥n." },
            { icon: "üÜô", text: "¬øQu√© es el 'Up-selling'?", options: ["Bajar precio", "Comprar versi√≥n superior o cara", "Vender arriba", "Vender techo"], correct: 1, explanation: "Ofrecer el modelo Pro al cliente que pregunta por el b√°sico, destacando beneficios.", tip: "El up-selling funciona si el cliente percibe que el valor extra compensa el precio." },
            { icon: "üö•", text: "¬øQu√© indican los 'Pasillos de Aspiraci√≥n'?", options: ["Aspiradora", "Pasillos anchos que dirigen el flujo", "Con aire", "Salida"], correct: 1, explanation: "Arterias principales que permiten cruzar la tienda r√°pidamente y ver secciones.", tip: "Coloca las mejores promociones en los bordes de estos pasillos para m√°xima exposici√≥n." },
            { icon: "üßÆ", text: "¬øQu√© es el 'Lineal'?", options: ["Regla", "Longitud de exposici√≥n en estanter√≠a", "Fila", "L√≠neas"], correct: 1, explanation: "Espacio f√≠sico asignado a una categor√≠a o producto dentro de la tienda.", tip: "El lineal es el recurso m√°s caro. Optimiza cada cent√≠metro seg√∫n rentabilidad." },
            { icon: "üìÖ", text: "¬øQu√© es la 'Estacionalidad'?", options: ["Cambiar estantes", "Variaci√≥n seg√∫n √©poca del a√±o", "Inventario", "Estaciones"], correct: 1, explanation: "Productos que solo se venden en fechas clave (turrones, ba√±adores).", tip: "Antic√≠pate: el 30% del √©xito es tener el stock antes de que empiece la temporada." }
        ];

        let questions = [];
        let score = 0;
        let currentQuestionIdx = 0;
        let timeLeft = 120;
        let gameActive = false;
        let phaserInstance = null;

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH,
                width: 1200,
                height: 700
            },
            transparent: true,
            scene: { preload, create, update }
        };

        function preload() {}

        function create() {
            phaserInstance = this;
            const graphics = this.add.graphics();
            graphics.lineStyle(1, 0x3b82f6, 0.05);
            for(let i=0; i<30; i++) {
                graphics.moveTo(i*40, 0); graphics.lineTo(i*40, 700);
                graphics.moveTo(0, i*40); graphics.lineTo(1200, i*40);
            }
            graphics.strokePath();

            if (questions.length > 0) showQuestion.call(this);

            this.time.addEvent({
                delay: 1000,
                callback: () => {
                    if (gameActive && timeLeft > 0) {
                        timeLeft--;
                        const timerUi = document.getElementById('timer-ui');
                        if(timerUi) {
                            timerUi.innerText = timeLeft + 's';
                            if(timeLeft < 20) timerUi.classList.add('text-red-500', 'animate-pulse');
                        }
                        if (timeLeft <= 0) gameOver();
                    }
                },
                loop: true
            });
        }

        function update() {}

        function showQuestion() {
            const q = questions[currentQuestionIdx];
            if(this.qContainer) this.qContainer.destroy();

            const container = this.add.container(600, 350);
            this.qContainer = container;

            // BLOQUE PREGUNTA - Estilo Slate/Blue
            const qBox = this.add.rectangle(-280, 0, 480, 340, 0x1e293b, 0.95);
            qBox.setStrokeStyle(2, 0x3b82f6, 0.5);
            
            const qIcon = this.add.text(-280, -110, q.icon, {
                fontSize: '64px', fontFamily: 'serif'
            }).setOrigin(0.5);

            const qTxt = this.add.text(-280, 40, q.text, {
                fontSize: '26px',
                fontWeight: '900',
                color: '#ffffff',
                fontFamily: 'Outfit',
                align: 'center',
                wordWrap: { width: 400 },
                lineSpacing: 8
            }).setOrigin(0.5);

            // BLOQUE OPCIONES
            q.options.forEach((opt, idx) => {
                const yPos = -120 + (idx * 80); 
                
                const btnBg = this.add.rectangle(210, yPos, 420, 68, 0x334155, 1);
                btnBg.setStrokeStyle(1, 0x3b82f6, 0.3);
                btnBg.setInteractive({ useHandCursor: true });
                
                const btnLetter = this.add.text(25, yPos, String.fromCharCode(65 + idx), {
                    fontSize: '14px', fontWeight: '900', color: '#ffffff', fontFamily: 'Space Grotesk',
                    backgroundColor: '#2563eb', padding: { x: 10, y: 10 }
                }).setOrigin(0.5);

                const btnTxt = this.add.text(75, yPos, opt, {
                    fontSize: '17px',
                    fontWeight: '700',
                    color: '#f1f5f9',
                    fontFamily: 'Outfit',
                    wordWrap: { width: 320 }
                }).setOrigin(0, 0.5);

                btnBg.on('pointerdown', () => {
                    if(gameActive) handleAnswer.call(this, idx === q.correct);
                });

                btnBg.on('pointerover', () => {
                    btnBg.setFillStyle(0x2563eb, 1);
                    btnBg.setStrokeStyle(2, 0xffffff, 0.5);
                    this.tweens.add({ targets: btnBg, x: 220, duration: 150 });
                });

                btnBg.on('pointerout', () => {
                    btnBg.setFillStyle(0x334155, 1);
                    btnBg.setStrokeStyle(1, 0x3b82f6, 0.3);
                    this.tweens.add({ targets: btnBg, x: 210, duration: 150 });
                });

                container.add([btnBg, btnLetter, btnTxt]);
            });

            container.add([qBox, qIcon, qTxt]);
            container.alpha = 0;
            this.tweens.add({ targets: container, alpha: 1, duration: 300 });

            document.getElementById('level-ui').innerText = `${currentQuestionIdx + 1}/10`;
        }

        function handleAnswer(isCorrect) {
            gameActive = false;
            score += isCorrect ? 250 : 50;
            document.getElementById('score-ui').innerText = score + '‚Ç¨';
            showFeedbackModal(isCorrect, questions[currentQuestionIdx]);
        }

        function showFeedbackModal(isCorrect, data) {
            const modal = document.getElementById('feedback-modal');
            const title = document.getElementById('modal-title');
            const header = document.getElementById('modal-header');
            const icon = document.getElementById('modal-icon');

            modal.style.display = 'flex';
            title.innerText = isCorrect ? '¬°MOVIMIENTO ELITE!' : 'FALLO DE SISTEMA';
            header.className = isCorrect ? 'p-6 text-white flex justify-between items-center bg-emerald-600 shrink-0' : 'p-6 text-white flex justify-between items-center bg-rose-600 shrink-0';
            
            document.getElementById('modal-desc').innerHTML = data.explanation;
            document.getElementById('modal-tip').innerText = data.tip;
            icon.setAttribute('data-lucide', isCorrect ? 'shield-check' : 'alert-octagon');
            
            document.getElementById('feedback-body').classList.remove('hidden');
            document.getElementById('next-btn').classList.remove('hidden');
            document.getElementById('gameover-btns').classList.add('hidden');
            lucide.createIcons();
        }

        window.closeModal = function() {
            document.getElementById('feedback-modal').style.display = 'none';
            currentQuestionIdx++;
            if (currentQuestionIdx >= 10) gameOver(true);
            else { gameActive = true; showQuestion.call(phaserInstance); }
        }

        function gameOver(completed = false) {
            gameActive = false;
            const modal = document.getElementById('feedback-modal');
            const title = document.getElementById('modal-title');
            const header = document.getElementById('modal-header');
            modal.style.display = 'flex';
            title.innerText = completed ? 'AUDITOR√çA FINALIZADA' : 'TIEMPO AGOTADO';
            header.className = 'p-6 text-white flex justify-between items-center bg-indigo-900 shrink-0';
            
            document.getElementById('feedback-body').classList.add('hidden');
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('gameover-btns').classList.remove('hidden');
            
            const body = document.getElementById('modal-content');
            const summary = document.createElement('div');
            summary.id = 'final-summary';
            summary.className = 'text-center py-10 rounded-[3rem] bg-slate-800 border-2 border-blue-500/20 shadow-2xl';
            
            const efficiency = Math.round((score / 2500) * 100);
            summary.innerHTML = `
                <div class="text-[10px] font-black text-blue-500 uppercase tracking-[0.5em] mb-4">TOTAL_PROFIT_GENERATED</div>
                <div class="text-7xl font-black text-white mb-8 italic">${score}‚Ç¨</div>
                <div class="inline-block px-8 py-3 bg-blue-600 rounded-2xl text-xs font-black uppercase tracking-widest text-white">Efficiency_Rating: ${efficiency}%</div>
            `;
            
            const oldSummary = document.getElementById('final-summary');
            if(oldSummary) oldSummary.remove();
            body.prepend(summary);
            lucide.createIcons();
        }

        window.startGame = function() {
            questions = shuffle([...allQuestions]).slice(0, 10);
            currentQuestionIdx = 0;
            score = 0;
            timeLeft = 120;
            gameActive = true;
            
            document.getElementById('intro-screen').style.display = 'none';
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('score-ui').innerText = '0‚Ç¨';
            document.getElementById('timer-ui').innerText = '120s';
            document.getElementById('timer-ui').classList.remove('text-red-500', 'animate-pulse');
            
            if(!phaserInstance) {
                new Phaser.Game(config);
            } else {
                showQuestion.call(phaserInstance);
            }
        }

        window.restartGame = function() {
            document.getElementById('feedback-modal').style.display = 'none';
            startGame();
        }

        lucide.createIcons();
    </script>
</body>
</html>